{%- set shipping_header = {
	'shippingTax_taxable_amount': shippingTax['taxable_amount'],
	'shippingTax_amount': shippingTax['amount'],
	'shippingTax_percent': shippingTax['percent'],
	'shippingTax_taxPointDate': shippingTax['taxPointDate'],
	'shippingTax_description': 	shippingTax['description']
	} 
-%}
{#- overwrite shipping information on header level in the ariba template if needed -#}
{%- for article in items -%}
	{%- if "shipping_article" in article.keys() -%}
		{%- for key in article.keys() -%}
			{%- if key not in ["price", "shipping_name", "position"] -%}
				{%- if shipping_header.update({'shippingTax_taxable_amount': article.price})-%}{%- endif -%}
				{%- if shipping_header.update({'shippingTax_amount': (tax['percent'] * article.price / 100) | round(2) }) -%}{%- endif -%}
				{%- if shipping_header.update({'shippingTax_percent': tax['percent'] }) -%}{%- endif -%}
				{%- if shipping_header.update({'shippingTax_description': tax_description}) -%}{%- endif -%}
				{%- if shipping_header.update({'summary_shipping_amount': article.price}) -%}{%- endif -%} 
			{%- endif -%}
		{%- endfor -%}
	{%- endif -%}
{%- endfor -%}
{%- set shippingTax_taxable_amount 	= shipping_header.shippingTax_taxable_amount -%}
{%- set shippingTax_amount 			= shipping_header.shippingTax_amount -%}
{%- set shippingTax_percent 		= shipping_header.shippingTax_percent -%}
{%- set shippingTax_taxPointDate 	= shipping_header.shippingTax_taxPointDate -%}
{%- set shippingTax_description 	= shipping_header.shippingTax_description -%}
{%- set summary_shipping_amount 	= shipping_header.shippingTax_taxable_amount -%}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE cXML SYSTEM "http://xml.cxml.org/schemas/cXML/1.2.028/InvoiceDetail.dtd">
<cXML payloadID = "{{basics_payload}}" timestamp = "2022-11-24T16:48:27+01:00" version = "1.2.028">
	<Header>
		<From>
			<Credential domain = "NetworkID">
				<Identity>{{ basics['sender_network_id'] }}</Identity>
			</Credential>
		</From>
		<To>
			<Credential domain = "NetworkID">
				<Identity>{{ basics['receiver_network_id'] }}</Identity>
			</Credential>
		</To>
		<Sender>
			<Credential domain = "NetworkID">
				<Identity>{{ basics['sender_network_id'] }}</Identity>
				<SharedSecret>{{ basics['shared_secret'] }}</SharedSecret>
			</Credential>
			<UserAgent>Supplier</UserAgent>
		</Sender>
	</Header>
	<Request Id = "cXMLData" deploymentMode = "production">
		<InvoiceDetailRequest>
			<InvoiceDetailRequestHeader invoiceDate = "{{ basics['invoice_date'] }}" invoiceID = "{{ basics['invoice_id'] }}" invoiceOrigin = "supplier" operation = "new" purpose = "standard">
				<InvoiceDetailHeaderIndicator/>
				<InvoiceDetailLineIndicator isTaxInLine = "yes"/>
				<InvoicePartner>
					<Contact addressID="99999" role="remitTo">
						<Name xml:lang="de-CH">{{ remitTo['name'] }}</Name>
						<PostalAddress>
							<Street>{{ remitTo['street'] }}</Street>
							<City>{{ remitTo['city'] }}</City>
							<PostalCode>{{ remitTo['pin'] }}</PostalCode>
							<Country isoCountryCode="{{ remitTo['iso_country_code'] }}"/>
						</PostalAddress>
					</Contact>
					<IdReference domain="supplierTaxID" identifier="{{remitTo['supplier_tax_id']}}"/>
				</InvoicePartner>
				<InvoicePartner>
					<Contact addressID="{{ billTo['address_id'] }}" role="billTo">
 						<Name xml:lang="de-CH">{{ billTo['name'] }}</Name>
  						<PostalAddress>
							<Street></Street>
							<City>{{ billTo['city'] }}</City>
							<PostalCode>{{ billTo['pin'] }}</PostalCode>
							<Country isoCountryCode="{{ billTo['iso_country_code'] }}"/>
						</PostalAddress>
					</Contact>
				</InvoicePartner>
				<InvoicePartner>
					<Contact role="from">
						<Name xml:lang="de-CH">{{ from['name'] }}</Name>
						<PostalAddress>
							<Street>{{ from['street'] }}</Street>
							<City>{{ from['city'] }}</City>
							<PostalCode>{{ from['pin'] }}</PostalCode>
							<Country isoCountryCode="{{ from['iso_country_code'] }}"/>
						</PostalAddress>
					</Contact>
				</InvoicePartner>
				<InvoicePartner>
					<Contact addressID="{{ soldTo['address_id'] }}" role="soldTo">
						<Name xml:lang="de-CH">{{ soldTo['name'] }}</Name>
						<PostalAddress>
							<Street>{{ soldTo['street'] }}</Street>
							<City>{{ soldTo['city'] }}</City>
							<PostalCode>{{ soldTo['pin'] }}</PostalCode>
							<Country isoCountryCode="{{ soldTo['iso_country_code'] }}"/>
						</PostalAddress>
					</Contact>
				</InvoicePartner>
				<InvoicePartner>
					<Contact role="wireReceivingBank">
						<Name xml:lang="de-CH"></Name>
					</Contact>
					<IdReference domain="swiftID" identifier="{{ receivingBank['swift_id'] }}"/>
					<IdReference domain="ibanID" identifier="{{ receivingBank['iban_id'] }}"/>
					<IdReference domain="accountName" identifier="{{ receivingBank['account_name'] }}"/>
					<IdReference domain="accountID" identifier="{{ receivingBank['account_id'] }}"/>
					<IdReference domain="accountType" identifier="{{ receivingBank['account_type'] }}"/>
					<IdReference domain="branchName" identifier="{{ receivingBank['branch_name'] }}"/>
				</InvoicePartner>
				<InvoiceDetailShipping>
					<Contact role="shipFrom">
						<Name xml:lang="de-CH">{{ shipFrom['name'] }}</Name>
						<PostalAddress>
							<Street>{{ shipFrom['street'] }}</Street>
							<City>{{ shipFrom['city'] }}</City>
							<PostalCode>{{ shipFrom['pin'] }}</PostalCode>
							<Country isoCountryCode="{{ shipFrom['iso_country_code'] }}"/>
						</PostalAddress>
					</Contact>
					<Contact addressID="{{ shipTo['address_id'] }}" role="shipTo">
						<Name xml:lang="de-CH">{{ shipTo['name'] }}</Name>
						<PostalAddress>
							<DeliverTo></DeliverTo>
							<Street>{{ shipTo['street'] }}</Street>
							<City>{{ shipTo['city'] }}</City>
							<State/>
							<PostalCode>{{ shipTo['pin'] }}</PostalCode>
							<Country isoCountryCode="{{ shipTo['iso_country_code'] }}"/>
						</PostalAddress>
					</Contact>
				</InvoiceDetailShipping>
 				<PaymentTerm payInNumberOfDays="45"></PaymentTerm>
				<Comments></Comments>
				<Extrinsic name="buyerVatID">{{ extrinsic['buyerVatId'] }}</Extrinsic>
				<Extrinsic name="supplierVatID">{{ extrinsic['supplierVatId'] }}</Extrinsic>
 				<Extrinsic name="invoiceSourceDocument">PurchaseOrder</Extrinsic>
				<Extrinsic name="invoiceSubmissionMethod">cXML</Extrinsic>
				<Extrinsic name="paymentMethod">wire</Extrinsic>
				<Extrinsic name="supplierCommercialIdentifier">{{ extrinsic['supplierCommercialIdentifier'] }}</Extrinsic>
			</InvoiceDetailRequestHeader>
			<InvoiceDetailOrder>
				<InvoiceDetailOrderInfo>
					<OrderReference orderID="{{ basics['order_id'] }}">
						<DocumentReference payloadID=""/>
					</OrderReference>
				</InvoiceDetailOrderInfo>
{%- for article in items -%}
	{%- if not "shipping_article" in article.keys() -%}
		{%- if "other_article" in article.keys() -%}
			{%- set item_invoiceLineNumber 		= article.invoice_position -%}
			{%- set item_quantity 				= article.quantity -%}
			{%- set item_unit_of_measure 		= "EA" -%}
			{%- set item_unit_price 			= article.price -%}
			{%- set item_supplier_part_id		= article["other_article"].item_code  -%}
			{%- set item_description 			= article.description -%}
			{%- set item_subtotal_amount 		= item_unit_price * item_quantity -%}
			{%- set item_tax_amount 			= (tax_percent * item_subtotal_amount / 100)|round(2)-%}
			{%- set item_tax_rate 				= tax_percent -%}
			{%- set item_tax_taxable_amount 	= item_subtotal_amount -%}
			{%- set item_tax_description 		= tax_description -%}
			{%- set item_gross_amount 			= item_subtotal_amount + item_tax_amount -%}
			{%- set item_net_amount 			= item_subtotal_amount + item_tax_amount -%}
		{%- else -%} {# Oligo article #}
			{%- set item_invoiceLineNumber 		= article.invoice_position -%}
			{%- set item_quantity 				= article.quantity -%}
			{%- set item_unit_of_measure 		= "EA" -%}
			{%- set item_unit_price 			= article.price -%}
			{%- set item_supplier_part_id		= article["oligo_article"].items[0].item_code  -%}
			{%- set item_description 			= article.description -%}
			{%- set item_subtotal_amount 		= article.price -%}
			{%- set item_tax_amount 			= ( tax['percent'] * article.price / 100) | round(2)-%}
			{%- set item_tax_rate 				= tax['percent'] -%}
			{%- set item_tax_taxable_amount 	= item_subtotal_amount -%}
			{%- set item_tax_description 		= tax_description -%}
			{%- set item_gross_amount 			= item_subtotal_amount + item_tax_amount -%}
			{%- set item_net_amount 			= item_subtotal_amount + item_tax_amount -%}
		{%- endif -%}
			{# These are the positions #}
				<InvoiceDetailItem invoiceLineNumber="{{item_invoiceLineNumber}}" quantity = "{{item_quantity}}">
					<UnitOfMeasure>EA</UnitOfMeasure>
					<UnitPrice>
						<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_unit_price) }}</Money> 
					</UnitPrice>
					<InvoiceDetailItemReference lineNumber="{{item_invoiceLineNumber}}">
						<ItemID>
							<SupplierPartID>{{item_supplier_part_id}}</SupplierPartID>
						</ItemID>
						<Description xml:lang="de-CH">{{item_description}}</Description>
					</InvoiceDetailItemReference>
					<SubtotalAmount>
						<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_subtotal_amount) }}</Money> 
					</SubtotalAmount>
					<Tax>
						<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_tax_amount) }}</Money>
						<Description xml:lang="de-CH"/>
						<TaxDetail category="vat" percentageRate="{{item_tax_rate}}" taxPointDate="{{tax_taxPointDate}}" exemptDetail="exempt">
							<TaxableAmount>
								<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_tax_taxable_amount) }}</Money> 
							</TaxableAmount>
							<TaxAmount>
								<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_tax_amount) }}</Money>
							</TaxAmount>
							<Description xml:lang="en">{{item_tax_description}}</Description>
						</TaxDetail>
					</Tax>
					<GrossAmount>
						<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_gross_amount) }}</Money>
					</GrossAmount>
					<NetAmount>
						<Money currency="{{ basics['currency'] }}">{{ "{:,.2f}".format(item_net_amount) }}</Money>
					</NetAmount>
				</InvoiceDetailItem>
	{%- endif -%}
{%- endfor -%}
{# end of first article iteration #}
 			</InvoiceDetailOrder>
			<InvoiceDetailSummary>
				<SubtotalAmount>
					<Money currency="{{ basics['currency'] }}">{{ summary['subtotal_amount'] }}</Money>
				</SubtotalAmount>
				<Tax>
					<Money currency="{{ basics['currency'] }}">{{ tax['amount'] }}</Money>
					<Description xml:lang="de-CH"/>
					<TaxDetail category="vat" percentageRate = "{{tax_percent}}" taxPointDate = "{{tax_taxPointDate}}">
						<TaxableAmount>
							<Money currency = "{{ basics['currency'] }}">{{ tax['taxable_amount'] }}</Money>
						</TaxableAmount>
						<TaxAmount>
							<Money currency = "{{ basics['currency'] }}">{{ tax['amount'] }}</Money>
						</TaxAmount>
						<Description xml:lang = "en">{{ tax['description'] }}</Description>
					</TaxDetail>
					<TaxDetail category="vat" percentageRate="{{shippingTax_percent}}" taxPointDate = "{{shippingTax_taxPointDate}}" exemptDetail="exempt"  purpose="shippingTax">
						<TaxableAmount>
							<Money currency="{{ basics['currency'] }}">{{ shippingTax['taxable_amount'] }}</Money>
						</TaxableAmount>
						<TaxAmount>
							<Money currency="{{ basics['currency'] }}">{{ shippingTax['amount'] }}</Money>
						</TaxAmount>
					<Description xml:lang="en">{{ shippingTax['description'] }}</Description>
					</TaxDetail>
				</Tax>
				<ShippingAmount>
					<Money currency = "{{ basics['currency'] }}">{{ summary['shipping_amount'] }}</Money>
				</ShippingAmount>
				<GrossAmount>
					<Money currency="{{ basics['currency'] }}">{{ summary['gross_amount'] }}</Money>
				</GrossAmount>
				<TotalAmountWithoutTax>
					<Money currency="{{ basics['currency'] }}">{{ summary['total_amount_without_tax'] }}</Money>
				</TotalAmountWithoutTax>
				<NetAmount>
					<Money currency="{{ basics['currency'] }}">{{ summary['net_amount'] }}</Money>
				</NetAmount>
				<DueAmount>
					<Money currency="{{ basics['currency'] }}">{{ summary['due_amount'] }}</Money>
				</DueAmount>
			</InvoiceDetailSummary>
		</InvoiceDetailRequest>
	</Request>
</cXML>
